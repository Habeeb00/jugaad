const CONFIG={proxyUrl:"/api/proxy?url=",eventUrlPattern:/tinkerhub\.org\/events\/([A-Z0-9]+)\//i,defaultDurationHours:2,timezone:"Asia/Kolkata"},elements={landingPage:document.getElementById("landing-page"),sharePage:document.getElementById("share-page"),loadingState:document.getElementById("loading-state"),eventState:document.getElementById("event-state"),errorState:document.getElementById("error-state"),installBtn:document.getElementById("install-btn"),manualUrl:document.getElementById("manual-url"),manualBtn:document.getElementById("manual-btn"),retryBtn:document.getElementById("retry-btn"),addGoogleCal:document.getElementById("add-google-cal"),eventTitle:document.getElementById("event-title"),eventType:document.getElementById("event-type"),eventDate:document.getElementById("event-date"),eventTime:document.getElementById("event-time"),eventLocation:document.getElementById("event-location"),eventDescriptionShort:document.getElementById("event-description-short"),eventSourceLink:document.getElementById("event-source-link"),errorMessage:document.getElementById("error-message")};let currentEventData=null,deferredInstallPrompt=null;function initApp(){const e=new URLSearchParams(window.location.search),t=window.location.pathname;"/share"===t||"/share.html"===t||e.has("url")||e.has("text")?handleShareTarget(e):showLandingPage(),setupEventListeners(),setupPWAInstall(),registerServiceWorker()}function setupEventListeners(){elements.manualBtn?.addEventListener("click",()=>{const e=elements.manualUrl?.value?.trim();e&&handleEventUrl(e)}),elements.manualUrl?.addEventListener("keypress",e=>{"Enter"===e.key&&elements.manualBtn?.click()}),elements.retryBtn?.addEventListener("click",()=>{currentEventData?.sourceUrl&&handleEventUrl(currentEventData.sourceUrl)}),elements.addGoogleCal?.addEventListener("click",()=>{currentEventData&&openGoogleCalendar(currentEventData)}),elements.installBtn?.addEventListener("click",async()=>{if(deferredInstallPrompt){deferredInstallPrompt.prompt();const{outcome:e}=await deferredInstallPrompt.userChoice;"accepted"===e&&(elements.installBtn.textContent="✓ Installed",elements.installBtn.disabled=!0),deferredInstallPrompt=null}})}function setupPWAInstall(){window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredInstallPrompt=e,elements.installBtn?.classList.remove("hidden")}),window.addEventListener("appinstalled",()=>{deferredInstallPrompt=null,elements.installBtn&&(elements.installBtn.textContent="✓ Installed",elements.installBtn.disabled=!0)}),window.matchMedia("(display-mode: standalone)").matches&&elements.installBtn&&(elements.installBtn.textContent="✓ Installed",elements.installBtn.disabled=!0)}function registerServiceWorker(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>console.log("SW registered:",e.scope)).catch(e=>console.log("SW registration failed:",e))}function showLandingPage(){elements.landingPage?.classList.remove("hidden"),elements.sharePage?.classList.add("hidden")}function showSharePage(){elements.landingPage?.classList.add("hidden"),elements.sharePage?.classList.remove("hidden")}function showLoadingState(){showSharePage(),elements.loadingState?.classList.remove("hidden"),elements.eventState?.classList.add("hidden"),elements.errorState?.classList.add("hidden")}function showEventState(){elements.loadingState?.classList.add("hidden"),elements.eventState?.classList.remove("hidden"),elements.errorState?.classList.add("hidden")}function showErrorState(e){elements.loadingState?.classList.add("hidden"),elements.eventState?.classList.add("hidden"),elements.errorState?.classList.remove("hidden"),elements.errorMessage&&(elements.errorMessage.textContent=e)}function handleShareTarget(e){let t=e.get("url")||"";const n=e.get("text")||"";e.get("title");if(!t&&n){const e=n.match(/https?:\/\/[^\s]+/);e&&(t=e[0])}t=t.replace(/\?$/,"").trim(),t&&CONFIG.eventUrlPattern.test(t)||t?handleEventUrl(t):(showLandingPage(),n&&elements.manualUrl&&(elements.manualUrl.value=n))}async function handleEventUrl(e){showLoadingState();try{const t=await fetchAndParseEvent(e);currentEventData=t,displayEventData(t),showEventState()}catch(t){console.error("Error fetching event:",t),currentEventData={sourceUrl:e},showErrorState(t.message||"Failed to fetch event details. Please try again.")}}async function fetchAndParseEvent(e){const t=CONFIG.proxyUrl+encodeURIComponent(e),n=await fetch(t,{headers:{Accept:"text/html,application/xhtml+xml"}});if(!n.ok)throw new Error(`Failed to fetch event page (${n.status})`);return parseEventHtml(await n.text(),e)}function parseEventHtml(e,t){const n=(new DOMParser).parseFromString(e,"text/html"),a={title:"",description:"",startDate:null,endDate:null,rawStartTime:"",rawEndTime:"",rawStartDate:"",rawEndDate:"",location:"",type:"Event",sourceUrl:t},r=n.querySelector('meta[property="og:title"]')?.content,o=n.querySelector('meta[property="og:description"]')?.content,l=n.querySelector("title")?.textContent?.split("»")[0]?.trim(),s=n.querySelector("h1, h2")?.textContent?.trim();a.title=r||s||l||"TinkerHub Event",a.title=a.title.replace(/\s*[»|]\s*TinkerHub$/i,"").trim(),a.description=o||"";n.querySelectorAll('[class*="badge"], [class*="tag"], [class*="chip"]').forEach(e=>{const t=e.textContent?.trim().toLowerCase();["workshop","hackathon","meetup","talk","webinar","conference","bootcamp"].includes(t)&&(a.type=e.textContent.trim())});const i=n.body?.textContent||"";i.includes("Workshop")?a.type="Workshop":i.includes("Hackathon")?a.type="Hackathon":i.includes("Meetup")&&(a.type="Meetup");let d=n.body?.innerText||"";const c=d.indexOf("These might interest you");c>-1&&(d=d.substring(0,c));const m=[...d.matchAll(/(Jan(?:uary)?|Feb(?:ruary)?|Mar(?:ch)?|Apr(?:il)?|May|Jun(?:e)?|Jul(?:y)?|Aug(?:ust)?|Sep(?:tember)?|Oct(?:ober)?|Nov(?:ember)?|Dec(?:ember)?)\s*(\d{1,2})\s*(\d{1,2}):(\d{2})\s*(AM|PM)/gi)],u=(new Date).getFullYear(),g=(e,t)=>{let n=e+5,a=t+30;return a>=60&&(a-=60,n+=1),n>=24&&(n-=24),{hour:n,minute:a}},p=(e,t)=>{const n=e>=12;return`${e%12||12}:${t.toString().padStart(2,"0")} ${n?"PM":"AM"}`};if(m.length>=1){const e=parseMonth(m[0][1]),t=parseInt(m[0][2]),n=g(parseHour(parseInt(m[0][3]),m[0][5]),parseInt(m[0][4]));a.rawStartDate=`${m[0][1]} ${t}`,a.rawStartTime=p(n.hour,n.minute),a.startDate=createISTDate(u,e,t,n.hour,n.minute);const r=new Date;if(a.startDate<r&&(a.startDate=createISTDate(u+1,e,t,n.hour,n.minute)),m.length>=2){const e=parseMonth(m[1][1]),t=parseInt(m[1][2]),n=g(parseHour(parseInt(m[1][3]),m[1][5]),parseInt(m[1][4]));a.rawEndDate=`${m[1][1]} ${t}`,a.rawEndTime=p(n.hour,n.minute),a.endDate=createISTDate(u,e,t,n.hour,n.minute),a.endDate<a.startDate&&(a.endDate=createISTDate(a.startDate.getFullYear()+1,e,t,n.hour,n.minute))}else a.endDate=new Date(a.startDate.getTime()+60*CONFIG.defaultDurationHours*60*1e3),a.rawEndTime=""}const h=n.querySelector(".address");h&&h.textContent.trim()&&(a.location=h.textContent.trim());const v=Array.from(n.querySelectorAll("div, span, p, h4, h5")).find(e=>"an event by"===e.textContent.trim().toLowerCase()&&0===e.children.length);if(v){const e=v.parentElement?.querySelector('[class*="badge"], a, span:not(:first-child)'),t=e?.textContent?.trim();t&&!t.toLowerCase().includes("tinkerhub")&&(a.location?a.location.includes(t)||t.includes(a.location)||(a.location=`${a.location}, ${t}`):a.location=t)}if(!a.location)if(d.toLowerCase().includes("online"))a.location="Online";else{const e=d.match(/(?:Location|Venue):\s*([^\n]+)/i);e&&(a.location=e[1].trim())}return!a.location&&d.includes("TinkerSpace")&&(a.location="TinkerSpace"),a}function parseMonth(e){return{jan:0,january:0,feb:1,february:1,mar:2,march:2,apr:3,april:3,may:4,jun:5,june:5,jul:6,july:6,aug:7,august:7,sep:8,september:8,oct:9,october:9,nov:10,november:10,dec:11,december:11}[e.toLowerCase()]??0}function parseHour(e,t){return"PM"===t.toUpperCase()&&12!==e?e+12:"AM"===t.toUpperCase()&&12===e?0:e}function createISTDate(e,t,n,a,r){const o=e=>e.toString().padStart(2,"0"),l=`${e}-${o(t+1)}-${o(n)}T${o(a)}:${o(r)}:00+05:30`;return new Date(l)}function displayEventData(e){if(elements.eventTitle&&(elements.eventTitle.textContent=e.title),elements.eventType&&(elements.eventType.textContent=e.type),elements.eventDate&&e.startDate)if(e.rawStartDate){let t=e.rawStartDate;e.rawEndDate&&e.rawEndDate!==e.rawStartDate&&(t+=` - ${e.rawEndDate}`),t+=`, ${e.startDate.getFullYear()}`,elements.eventDate.textContent=t}else{const t={month:"long",day:"numeric",year:"numeric",timeZone:CONFIG.timezone};let n=e.startDate.toLocaleDateString("en-US",t);e.endDate&&e.endDate.getDate()!==e.startDate.getDate()&&(n=`${e.startDate.toLocaleDateString("en-US",{month:"long",day:"numeric",timeZone:CONFIG.timezone})} - ${e.endDate.toLocaleDateString("en-US",t)}`),elements.eventDate.textContent=n}if(elements.eventTime&&e.startDate)if(e.rawStartTime){let t=e.rawStartTime;e.rawEndTime&&(t+=` - ${e.rawEndTime}`),elements.eventTime.textContent=t}else{const t={hour:"numeric",minute:"2-digit",hour12:!0,timeZone:CONFIG.timezone};let n=e.startDate.toLocaleTimeString("en-US",t);e.endDate&&(n+=` - ${e.endDate.toLocaleTimeString("en-US",t)}`),elements.eventTime.textContent=n}if(elements.eventLocation&&(elements.eventLocation.textContent=e.location||"Location TBA"),elements.eventDescriptionShort){const t=e.description?.length>150?e.description.substring(0,150)+"...":e.description||"No description available.";elements.eventDescriptionShort.textContent=t}elements.eventSourceLink&&(elements.eventSourceLink.href=e.sourceUrl)}function formatDateForGoogle(e){const t=e=>e.toString().padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}T${t(e.getHours())}${t(e.getMinutes())}00`}function openGoogleCalendar(e){if(!e.startDate||!e.endDate)return void alert("Could not determine event dates. Please check the original event page.");const t=e=>{const t=e=>e.toString().padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}T${t(e.getHours())}${t(e.getMinutes())}00`},n=t(e.startDate),a=t(e.endDate),r=encodeURIComponent(e.title),o=encodeURIComponent(e.location||""),l=encodeURIComponent(`${e.description}\n\nOriginal event: ${e.sourceUrl}`),s=/android/i.test(navigator.userAgent);/mobile|android|iphone|ipad/i.test(navigator.userAgent);if(s){const e=`intent://calendar.google.com/calendar/render?action=TEMPLATE&text=${r}&dates=${n}/${a}&location=${o}&details=${l}&ctz=${CONFIG.timezone}#Intent;scheme=https;package=com.google.android.calendar;end`,t=document.createElement("a");t.href=e,document.body.appendChild(t),t.click(),document.body.removeChild(t)}else{const t=`https://calendar.google.com/calendar/render?${new URLSearchParams({action:"TEMPLATE",text:e.title,dates:`${n}/${a}`,details:`${e.description}\n\nOriginal event: ${e.sourceUrl}`,location:e.location||"",ctz:CONFIG.timezone}).toString()}`;window.open(t,"_blank")}}document.addEventListener("DOMContentLoaded",()=>{initApp()});